<view class="container">
  <!-- å¯åŠ¨å°é¢ -->
  <view class="start-cover" wx:if="{{showStartCover}}">
    <image class="cover-image" src="/images/æ¸¸æˆå°é¢.png" mode="aspectFit"></image>
  </view>

  <!-- é¡¶éƒ¨å·¥å…·æ  - å›ºå®šåœ¨é¡¶éƒ¨ -->
  <view class="top-toolbar">
    <!-- å·¦ä¾§ï¼šè¿æ¥çŠ¶æ€ -->
    <view class="status-compact">
      <text class="status-dot {{connected ? 'dot-connected' : 'dot-disconnected'}}"></text>
      <text class="status-text">{{connected ? deviceName : 'æœªè¿æ¥'}}</text>
    </view>
    
    <!-- ä¸­é—´ï¼šæœåŠ¡å™¨çŠ¶æ€ -->
    <view class="server-status-compact">
      <text class="status-dot {{socketConnected ? 'dot-connected' : 'dot-disconnected'}}"></text>
      <text class="status-text">{{socketConnected ? 'æœåŠ¡å™¨' : (isReconnecting ? 'é‡è¿(' + reconnectAttempts + ')' : 'ç¦»çº¿')}}</text>
    </view>
    
    <!-- å³ä¾§ï¼šå¿«æ·æŒ‰é’® -->
    <view class="toolbar-actions">
      <view class="icon-btn" bindtap="toggleSound">
        <text class="icon">{{soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}}</text>
      </view>
      <view class="icon-btn" bindtap="navigateToScan">
        <text class="icon">{{connected ? 'ğŸ”„' : 'ğŸ”'}}</text>
      </view>
      <view class="icon-btn" bindtap="toggleDataSending" wx:if="{{connected}}">
        <text class="icon">{{isDataSending ? 'â¹ï¸' : 'â–¶ï¸'}}</text>
      </view>
      <view class="icon-btn" bindtap="navigateToHistory">
        <text class="icon">ğŸ“Š</text>
      </view>
    </view>
  </view>

  <!-- ä¾§è¾¹æ•°æ®é¢æ¿ - å¯æŠ˜å  -->
  <view class="side-panel {{showDataPanel ? 'panel-open' : 'panel-collapsed'}}" wx:if="{{experimentStarted && currentPhase !== 'æ²»ç–—é˜¶æ®µ'}}">
    <view class="panel-toggle" bindtap="toggleDataPanel">
      <text class="toggle-icon">{{showDataPanel ? 'â—€' : 'â–¶'}}</text>
    </view>
    <view class="panel-content" wx:if="{{showDataPanel}}">
      <view class="data-row">
        <text class="data-label">æ ·æœ¬ç†µ</text>
        <text class="data-value">{{powerRatio !== null ? powerRatio : '--'}}</text>
      </view>
      <view class="data-row">
        <text class="data-label">åŸºå‡†å€¼</text>
        <text class="data-value">{{baselineValue !== null ? baselineValue : '--'}}</text>
      </view>
      <view class="data-row">
        <text class="data-label">å½“å‰æ³¨æ„åŠ›</text>
        <text class="data-value">{{currentAttention !== null ? currentAttention : '--'}}</text>
      </view>
      <!-- è¿·ä½ å›¾è¡¨ -->
      <view class="mini-chart">
        <canvas
          canvas-id="eegChart"
          style="width:100%; height:120px;"
          disable-scroll="true"
        ></canvas>
      </view>
    </view>
  </view>

  <!-- åŸºçº¿æ”¶é›†é˜¶æ®µ -->
  <view class="baseline-container" wx:if="{{currentPhase === 'åŸºå‡†é˜¶æ®µ'}}">
    <image class="baseline-bg-image" src="/images/æ­£åœ¨ç”Ÿæˆå°é•‡.png" mode="widthFix"></image>
    <view class="baseline-content">
      <view class="baseline-title">è¯·ä¿æŒæ”¾æ¾ï¼Œå°é•‡æ­£åœ¨ç”Ÿæˆ</view>
      <view class="progress-container">
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{(30-remainingTime)/30*100}}%"></view>
        </view>
        <view class="progress-text">{{Math.floor((30-remainingTime)/30*100)}}%</view>
      </view>
      <view class="baseline-time">å‰©ä½™æ—¶é—´ï¼š{{remainingTime}}ç§’</view>
    </view>
  </view>

  <!-- ä¿å«å°é•‡æ¸¸æˆç•Œé¢ -->
  <view class="game-container" wx:if="{{currentPhase === 'æ²»ç–—é˜¶æ®µ'}}"
        catchtouchmove="preventPageScroll"
        bindtouchstart="onMapTouchStart"
        bindtouchmove="onMapTouchMove"
        bindtouchend="onMapTouchEnd">
    
    <!-- æ¸¸æˆèƒŒæ™¯å›¾ç‰‡ -->
    <image wx:if="{{gameBackground}}" class="game-background" src="{{gameBackground}}" mode="aspectFill"></image>
    
    <!-- æ¸¸æˆä¸–ç•Œå®¹å™¨ï¼ˆå¯æ‹–åŠ¨ï¼‰ -->
    <view class="game-world" style="transform: translate({{mapOffsetX}}px, {{mapOffsetY}}px);">
      <!-- å°é•‡ï¼ˆä¸­å¿ƒä½ç½®ï¼‰ -->
      <view class="town" style="left: {{town.x}}rpx; top: {{town.y}}rpx;">
        <view class="town-body">ğŸ°</view>
        <!-- å°é•‡è¡€æ¡ -->
        <view class="health-bar town-health">
          <view class="health-fill" style="width: {{town.hp/town.maxHp*100}}%"></view>
          <text class="health-text">{{town.hp}}/{{town.maxHp}}</text>
        </view>
      </view>

      <!-- ç‚®å° -->
      <view wx:for="{{turrets}}" wx:key="id" class="turret" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx; transform: translate(-50%, -50%) rotate({{item.rotation}}deg);">
        <image wx:if="{{item.image}}" class="turret-image" src="{{item.image}}" mode="aspectFit"></image>
        <view wx:else class="turret-body">ğŸ”«</view>
      </view>

      <!-- æ€ªç‰© -->
      <view wx:for="{{monsters}}" wx:key="id" class="monster {{item.isBoss ? 'boss-monster' : ''}}" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <image wx:if="{{item.image}}" class="monster-image {{item.isBoss ? 'boss-image' : ''}}" src="{{item.image}}" mode="aspectFit"></image>
        <view wx:else class="monster-body {{item.isBoss ? 'boss-body' : ''}}">{{item.isBoss ? 'ğŸ‘¹' : 'ğŸ‘¾'}}</view>
        <!-- æ€ªç‰©è¡€æ¡ -->
        <view class="health-bar monster-health" wx:if="{{item.maxHp > 1}}">
          <view class="health-fill monster-fill" style="width: {{item.hp/item.maxHp*100}}%"></view>
        </view>
        <!-- Bossæ ‡è®° -->
        <view wx:if="{{item.isBoss}}" class="boss-label">BOSS</view>
      </view>

      <!-- å­å¼¹ -->
      <view wx:for="{{bullets}}" wx:key="id" class="bullet" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <image wx:if="{{item.image}}" class="bullet-image" src="{{item.image}}" mode="aspectFit"></image>
        <view wx:else class="bullet-body">ğŸ’¥</view>
      </view>

      <!-- çˆ†ç‚¸æ•ˆæœ -->
      <view wx:for="{{explosions}}" wx:key="id" class="explosion" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <view class="explosion-body">ğŸ’¢</view>
      </view>
    </view>

    <!-- æ¸¸æˆçŠ¶æ€é¢æ¿ - å³ä¾§æ»‘å—å½¢å¼ -->
    <view class="game-stats-panel {{showGameStats ? '' : 'stats-panel-collapsed'}}">
      <!-- æŠ˜å æŒ‰é’® -->
      <view class="stats-panel-toggle" bindtap="toggleGameStats">
        <text class="toggle-icon">{{showGameStats ? 'â–¶' : 'â—€'}}</text>
      </view>
      
      <view class="stats-panel-content" wx:if="{{showGameStats}}">
        <view class="stats-title">æ¸¸æˆçŠ¶æ€</view>
        
        <view class="stats-grid">
          <view class="grid-item">
            <text class="grid-label">å­˜æ´»</text>
            <text class="grid-value">{{survivedTime}}s</text>
          </view>
          <view class="grid-item">
            <text class="grid-label">ç­‰çº§</text>
            <text class="grid-value">Lv.{{playerLevel}}</text>
          </view>
          <view class="grid-item">
            <text class="grid-label">æ³¢æ¬¡</text>
            <text class="grid-value">{{currentWave}}</text>
          </view>
          <view class="grid-item">
            <text class="grid-label">å‡»è´¥</text>
            <text class="grid-value">{{defeatedMonsters}}</text>
          </view>
        </view>
        
        <view class="stats-divider"></view>
        
        <view class="attention-section">
          <view class="attention-item">
            <text class="attention-label">åŸºå‡†å€¼</text>
            <text class="attention-value baseline">{{baselineValue || '--'}}</text>
          </view>
          <view class="attention-item">
            <text class="attention-label">å½“å‰å€¼</text>
            <text class="attention-value current">{{currentAttention || '--'}}</text>
          </view>
        </view>
        
        <view class="stats-divider"></view>
        
        <view class="exp-section">
          <view class="exp-header">
            <text class="exp-label">ç»éªŒå€¼</text>
            <text class="exp-text">{{experience}}/{{nextLevelExp}}</text>
          </view>
          <view class="exp-bar">
            <view class="exp-fill" style="width: {{experience/nextLevelExp*100}}%"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç‚®å°ä¿¡æ¯é¢æ¿ - å·¦ä¸‹è§’å¯æŠ˜å  -->
    <view class="turret-panel {{showTurretPanel ? '' : 'turret-panel-collapsed'}}">
      <!-- æŠ˜å æŒ‰é’® -->
      <view class="turret-toggle" bindtap="toggleTurretPanel">
        <text class="toggle-icon">{{showTurretPanel ? 'â—€' : 'â–¶'}}</text>
      </view>
      
      <view class="turret-content" wx:if="{{showTurretPanel}}">
        <view class="turret-title">ç‚®å°çŠ¶æ€</view>
        <view class="turret-list">
          <view class="turret-info-item" wx:for="{{turrets}}" wx:key="id">
            <view class="turret-header">
              <text class="turret-icon">âš”ï¸</text>
              <text class="turret-name">ç‚®å° {{index + 1}}</text>
            </view>
            <view class="turret-details">
              <view class="detail-item">
                <text class="detail-label">æ”»å‡»åŠ›</text>
                <text class="detail-value">{{item.damage}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">ç›®æ ‡æ•°</text>
                <text class="detail-value">{{item.targets}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">æ”»é€Ÿ</text>
                <text class="detail-value attack-speed">{{item.attackInterval}}ms</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç»“æŸæ¸¸æˆæŒ‰é’® -->
    <view class="end-game-btn" bindtap="endGameManually">
      <text>ç»“æŸæ¸¸æˆ</text>
    </view>

    <!-- æ¸¸æˆå¼€å§‹æç¤º -->
    <view class="game-prompt" wx:if="{{showGamePrompt}}">
      <text class="prompt-text">è¯·é›†ä¸­æ³¨æ„åŠ›ï¼Œä¿å«å°é•‡ï¼</text>
    </view>
    
    <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
    <view class="game-over" wx:if="{{gameOver}}">
      <view class="game-over-content">
        <view class="game-over-title">å°é•‡æ²¦é™·</view>
        <view class="game-over-stats">
          <view>å­˜æ´»æ—¶é—´: {{survivedTime}}ç§’</view>
          <view>æœ€ç»ˆç­‰çº§: {{playerLevel}}</view>
          <view>å‡»è´¥æ€ªç‰©: {{defeatedMonsters}}</view>
          <view>åˆ°è¾¾æ³¢æ¬¡: {{currentWave}}</view>
        </view>
        <view class="game-over-tip">æ¸¸æˆå·²ç»“æŸï¼Œè¯·åœæ­¢å®éªŒåæŸ¥çœ‹å†å²è®°å½•</view>
        <button class="game-over-btn" bindtap="stopExperiment">åœæ­¢å®éªŒ</button>
      </view>
    </view>
  </view>
  
  <!-- åº•éƒ¨æµ®åŠ¨æ“ä½œæ  -->
  <view class="bottom-action-bar" wx:if="{{!experimentStarted || currentPhase !== 'æ²»ç–—é˜¶æ®µ'}}">
    <!-- ä¸»æ“ä½œæŒ‰é’® -->
    <view class="main-action">
      <button
        class="action-btn-large {{socketConnected && connected ? 'btn-ready' : 'btn-disabled'}}"
        bindtap="startExperiment"
        wx:if="{{!experimentStarted && connected}}"
        disabled="{{!socketConnected}}"
      >
        <text class="btn-icon">ğŸš€</text>
        <text class="btn-text">{{socketConnected ? 'å¼€å§‹è®­ç»ƒ' : 'ç­‰å¾…è¿æ¥...'}}</text>
      </button>

      <button
        class="action-btn-large btn-danger"
        bindtap="stopExperiment"
        wx:if="{{experimentStarted}}"
      >
        <text class="btn-icon">â¹ï¸</text>
        <text class="btn-text">ç»“æŸå®éªŒ</text>
      </button>
    </view>
    
    <!-- æ¬¡è¦æ“ä½œ -->
    <view class="secondary-actions" wx:if="{{!experimentStarted}}">
      <view class="action-item" bindtap="navigateToSchulte">
        <text class="action-icon">ğŸ¯</text>
        <text class="action-label">èˆ’å°”ç‰¹</text>
      </view>
    </view>
  </view>
</view>
