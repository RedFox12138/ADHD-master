<view class="container">
  <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
  <view class="status-card">
    <view class="status">
      è®¾å¤‡çŠ¶æ€ï¼š{{connected ? 'å·²è¿æ¥ ' + deviceName : 'æœªè¿æ¥'}}
    </view>
    <view class="status {{socketConnected ? 'status-online' : 'status-offline'}}">
      æœåŠ¡å™¨ï¼š{{socketConnected ? 'å·²è¿æ¥ âœ“' : (isReconnecting ? 'é‡è¿ä¸­...' : 'æœªè¿æ¥ âœ—')}}
      {{isReconnecting ? '(ç¬¬' + reconnectAttempts + 'æ¬¡)' : ''}}
    </view>
  </view>
  
  <!-- å›¾è¡¨åŒºåŸŸ -->
  <view class="chart-container">
    <canvas
      canvas-id="eegChart"
      style="width:100%; height:200px;"
      disable-scroll="true"
    ></canvas>
  </view>

  <!-- å‚æ•°æ˜¾ç¤º -->
  <view class="parameter">
    <view>âš¡ æ ·æœ¬ç†µï¼š{{powerRatio !== null ? powerRatio : 'æœªè®¡ç®—'}}</view>
  </view>

  <!-- åŸºçº¿æ”¶é›†é˜¶æ®µ -->
  <view class="baseline-container" wx:if="{{currentPhase === 'åŸºå‡†é˜¶æ®µ'}}">
    <view class="baseline-title">è¯·ä¿æŒæ”¾æ¾ï¼Œå°é•‡æ­£åœ¨ç”Ÿæˆ</view>
    <view class="progress-container">
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{(30-remainingTime)/30*100}}%"></view>
      </view>
      <view class="progress-text">{{Math.floor((30-remainingTime)/30*100)}}%</view>
    </view>
    <view class="baseline-time">å‰©ä½™æ—¶é—´ï¼š{{remainingTime}}ç§’</view>
  </view>

  <!-- ä¿å«å°é•‡æ¸¸æˆç•Œé¢ -->
  <view class="game-container" wx:if="{{currentPhase === 'æ²»ç–—é˜¶æ®µ'}}"
        catchtouchmove="preventPageScroll"
        bindtouchstart="onMapTouchStart"
        bindtouchmove="onMapTouchMove"
        bindtouchend="onMapTouchEnd">
    
    <!-- æ¸¸æˆä¸–ç•Œå®¹å™¨ï¼ˆå¯æ‹–åŠ¨ï¼‰ -->
    <view class="game-world" style="transform: translate({{mapOffsetX}}px, {{mapOffsetY}}px);">
      <!-- å°é•‡ï¼ˆä¸­å¿ƒä½ç½®ï¼‰ -->
      <view class="town" style="left: {{town.x}}rpx; top: {{town.y}}rpx;">
        <view class="town-body">ğŸ°</view>
        <!-- å°é•‡è¡€æ¡ -->
        <view class="health-bar town-health">
          <view class="health-fill" style="width: {{town.hp/town.maxHp*100}}%"></view>
          <text class="health-text">{{town.hp}}/{{town.maxHp}}</text>
        </view>
      </view>

      <!-- ç‚®å° -->
      <view wx:for="{{turrets}}" wx:key="id" class="turret" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx; transform: translate(-50%, -50%) rotate({{item.rotation}}deg);">
        <view class="turret-body">ğŸ”«</view>
      </view>

      <!-- æ€ªç‰© -->
      <view wx:for="{{monsters}}" wx:key="id" class="monster {{item.isBoss ? 'boss-monster' : ''}}" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <view class="monster-body {{item.isBoss ? 'boss-body' : ''}}">{{item.isBoss ? 'ğŸ‘¹' : 'ğŸ‘¾'}}</view>
        <!-- æ€ªç‰©è¡€æ¡ -->
        <view class="health-bar monster-health" wx:if="{{item.maxHp > 1}}">
          <view class="health-fill monster-fill" style="width: {{item.hp/item.maxHp*100}}%"></view>
        </view>
        <!-- Bossæ ‡è®° -->
        <view wx:if="{{item.isBoss}}" class="boss-label">BOSS</view>
      </view>

      <!-- å­å¼¹ -->
      <view wx:for="{{bullets}}" wx:key="id" class="bullet" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <view class="bullet-body">ğŸ’¥</view>
      </view>

      <!-- çˆ†ç‚¸æ•ˆæœ -->
      <view wx:for="{{explosions}}" wx:key="id" class="explosion" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <view class="explosion-body">ğŸ’¢</view>
      </view>
    </view>

    <!-- æ¸¸æˆçŠ¶æ€é¢æ¿ -->
    <view class="game-stats">
      <view class="stat-row">
        <view class="stat-item">
          <text class="stat-label">å­˜æ´»</text>
          <text class="stat-value">{{survivedTime}}s</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">ç­‰çº§</text>
          <text class="stat-value">{{playerLevel}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">æ³¢æ¬¡</text>
          <text class="stat-value">{{currentWave}}</text>
        </view>
      </view>
      <view class="stat-row">
        <view class="stat-item">
          <text class="stat-label">åŸºå‡†</text>
          <text class="stat-value">{{baselineValue || '--'}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å½“å‰</text>
          <text class="stat-value">{{currentAttention || '--'}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å‡»è´¥</text>
          <text class="stat-value">{{defeatedMonsters}}</text>
        </view>
      </view>
      <view class="stat-row">
        <view class="stat-item-full">
          <text class="stat-label">ç»éªŒ</text>
          <text class="stat-value">{{experience}}/{{nextLevelExp}}</text>
        </view>
      </view>
      <view class="exp-bar">
        <view class="exp-fill" style="width: {{experience/nextLevelExp*100}}%"></view>
      </view>
    </view>

    <!-- ç»“æŸæ¸¸æˆæŒ‰é’® -->
    <view class="end-game-btn" bindtap="endGameManually">
      <text>ç»“æŸæ¸¸æˆ</text>
    </view>

    <!-- æ¸¸æˆå¼€å§‹æç¤º -->
    <view class="game-prompt" wx:if="{{showGamePrompt}}">
      <text class="prompt-text">è¯·é›†ä¸­æ³¨æ„åŠ›ï¼Œä¿å«å°é•‡ï¼</text>
    </view>
    
    <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
    <view class="game-over" wx:if="{{gameOver}}">
      <view class="game-over-content">
        <view class="game-over-title">å°é•‡æ²¦é™·</view>
        <view class="game-over-stats">
          <view>å­˜æ´»æ—¶é—´: {{survivedTime}}ç§’</view>
          <view>æœ€ç»ˆç­‰çº§: {{playerLevel}}</view>
          <view>å‡»è´¥æ€ªç‰©: {{defeatedMonsters}}</view>
          <view>åˆ°è¾¾æ³¢æ¬¡: {{currentWave}}</view>
        </view>
        <button class="restart-btn" bindtap="restartExperiment">é‡æ–°å¼€å§‹</button>
      </view>
    </view>
  </view>
  
  
  <!-- å®éªŒä¿¡æ¯ -->
  <view class="experiment-info" wx:if="{{experimentStarted && currentPhase !== 'æ²»ç–—é˜¶æ®µ'}}">
    <view wx:if="{{currentPhase === 'å‡†å¤‡é˜¶æ®µ'}}">
      <text>ğŸ¯ å‡†å¤‡ä¸­ï¼š{{remainingTime}}ç§’åå¼€å§‹åŸºå‡†æµ‹è¯•</text>
    </view>
    <view>ğŸ“Š å®éªŒé˜¶æ®µï¼š{{currentPhase}}</view>
    <view>â° å‰©ä½™æ—¶é—´ï¼š{{remainingTime}}ç§’</view>
    <view>ğŸ“ åŸºå‡†å€¼ï¼š{{baselineValue !== null ? baselineValue : 'è®¡ç®—ä¸­'}}</view>
    <view>ğŸ§  å½“å‰æ³¨æ„åŠ›ï¼š{{currentAttention !== null ? currentAttention : 'è®¡ç®—ä¸­'}}</view>
  </view>
  
  <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
  <view class="control-panel">
    <!-- ä¸»è¦æ“ä½œæŒ‰é’® -->
    <view class="main-actions">
      <button class="control-btn primary" bindtap="navigateToScan">
        {{connected ? 'ğŸ”„ é‡æ–°è¿æ¥' : 'ï¿½ æœç´¢è®¾å¤‡'}}
      </button>
      
      <!-- æ•°æ®å‘é€åˆ‡æ¢æŒ‰é’® -->
      <button 
        class="control-btn {{isDataSending ? 'danger' : 'success'}}" 
        bindtap="toggleDataSending"
        wx:if="{{connected}}"
      >
        {{isDataSending ? 'â¹ï¸ åœæ­¢å‘é€' : 'â–¶ï¸ å‘é€æ•°æ®'}}
      </button>

      <button
        class="control-btn success"
        bindtap="startExperiment"
        wx:if="{{!experimentStarted && connected}}"
        disabled="{{!socketConnected}}"
      >
        {{socketConnected ? 'ğŸš€ å¼€å§‹å®éªŒ' : 'â³ ç­‰å¾…æœåŠ¡å™¨è¿æ¥...'}}
      </button>

      <button
        class="control-btn danger"
        bindtap="stopExperiment"
        wx:if="{{experimentStarted}}"
      >
        â¹ï¸ ç»“æŸå®éªŒ
      </button>

      <button class="control-btn secondary" bindtap="navigateToHistory">
        ğŸ“Š å†å²è®°å½•
      </button>
    </view>
  </view>
</view>