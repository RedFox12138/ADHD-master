<wxs module="utils">
  var formatExp = function(exp) {
    if (exp === undefined || exp === null || exp === '') {
      return 0;
    }
    return Math.floor(exp);
  }
  module.exports = {
    formatExp: formatExp
  }
</wxs>

<view class="container">
  <!-- æ³¨æ„åŠ›æé†’ -->
  <view class="attention-alert" wx:if="{{showAttentionAlert}}">
    <view class="alert-text">âš ï¸ åŠ æ²¹ï¼é›†ä¸­æ³¨æ„åŠ›ï¼</view>
  </view>

  <!-- å¤§æ‹›æ¿€æ´»ç‰¹æ•ˆ -->
  <view class="ultimate-alert" wx:if="{{showUltimateEffect}}">
    <view class="ultimate-text">ğŸŒŸ è¶…çº§ç«åŠ›æ¿€æ´»ï¼ğŸŒŸ</view>
    <view class="ultimate-subtext">æŒç»­4ç§’</view>
  </view>

  <!-- å¯åŠ¨å°é¢ -->
  <view class="start-cover" wx:if="{{showStartCover}}">
    <image class="cover-image" src="/images/æ¸¸æˆå°é¢.png" mode="aspectFit"></image>
  </view>

  <!-- æ¨¡å¼é€‰æ‹©ç•Œé¢ -->
  <view class="mode-selector" wx:if="{{showModeSelector}}">
    <view class="mode-modal">
      <view class="mode-title">é€‰æ‹©æ¸¸æˆæ¨¡å¼</view>
      <view class="mode-desc">ä¸åŒæ¨¡å¼å¯¹åº”ä¸åŒçš„åˆ¤æ–­é€»è¾‘</view>
      
      <view class="mode-options">
        <!-- è‡ªåŠ¨æ¨¡å¼ -->
        <view class="mode-option auto" bindtap="selectAutoMode">
          <view class="mode-icon">ğŸ¤–</view>
          <view class="mode-name">è‡ªåŠ¨æ¨¡å¼</view>
          <view class="mode-info">
            éœ€è¦å®Œæˆ2æ¬¡ç¦»çº¿å®éªŒæ ‡å®š
          </view>
          <view class="mode-status" wx:if="{{userCalibrated}}">
            âœ… å·²å®Œæˆæ ‡å®š ({{calibrationData.user_type}})
          </view>
          <view class="mode-status warning" wx:else>
            âš ï¸ æœªå®Œæˆæ ‡å®š
          </view>
        </view>
        
        <!-- æ‰‹åŠ¨æ¨¡å¼ -->
        <view class="mode-option manual">
          <view class="mode-icon">âœ‹</view>
          <view class="mode-name">æ‰‹åŠ¨æ¨¡å¼</view>
          <view class="mode-info">
            æ‰‹åŠ¨é€‰æ‹©åˆ¤æ–­é€»è¾‘ç±»å‹
          </view>
          
          <view class="manual-types">
            <view class="type-btn type-a" bindtap="selectManualMode" data-type="type_A">
              <view class="type-name">Aç±»</view>
              <view class="type-desc">é€‚åˆé«˜æ´»è·ƒå‹</view>
            </view>
            <view class="type-btn type-b" bindtap="selectManualMode" data-type="type_B">
              <view class="type-name">Bç±»</view>
              <view class="type-desc">é€‚åˆä½æ´»è·ƒå‹</view>
            </view>
          </view>
        </view>
      </view>
      
      <view class="mode-current" wx:if="{{mode}}">
        å½“å‰æ¨¡å¼: {{mode === 'auto' ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'}} 
        ({{userType === 'type_A' ? 'Aç±»' : 'Bç±»'}})
      </view>
    </view>
  </view>

  <!-- éš¾åº¦é€‰æ‹©ç•Œé¢ -->
  <view class="difficulty-selector" wx:if="{{showDifficultySelector}}">
    <view class="difficulty-modal">
      <view class="difficulty-title">é€‰æ‹©æ¸¸æˆéš¾åº¦</view>
      <view class="difficulty-desc">ä¸åŒéš¾åº¦ä¼šå½±å“å‡çº§é€Ÿåº¦</view>
      
      <view class="difficulty-options">
        <view class="difficulty-option easy" bindtap="selectDifficulty" data-difficulty="easy">
          <view class="difficulty-icon">ğŸ˜Š</view>
          <view class="difficulty-name">ç®€å•</view>
          <view class="difficulty-info">ç»éªŒå€¼ +50%</view>
        </view>
        
        <view class="difficulty-option normal" bindtap="selectDifficulty" data-difficulty="normal">
          <view class="difficulty-icon">ğŸ˜</view>
          <view class="difficulty-name">æ™®é€š</view>
          <view class="difficulty-info">æ ‡å‡†éš¾åº¦</view>
        </view>
        
        <view class="difficulty-option hard" bindtap="selectDifficulty" data-difficulty="hard">
          <view class="difficulty-icon">ğŸ˜¤</view>
          <view class="difficulty-name">å›°éš¾</view>
          <view class="difficulty-info">ç»éªŒå€¼ -30%</view>
        </view>
      </view>
    </view>
  </view>

  <!-- é¡¶éƒ¨å·¥å…·æ  - å›ºå®šåœ¨é¡¶éƒ¨ -->
  <view class="top-toolbar">
    <!-- çŠ¶æ€ä¿¡æ¯åŒº -->
    <view class="status-info-area">
      <!-- è®¾å¤‡è¿æ¥çŠ¶æ€ -->
      <view class="status-item">
        <text class="status-dot {{connected ? 'dot-connected' : 'dot-disconnected'}}"></text>
        <text class="status-label">è®¾å¤‡:</text>
        <text class="status-value">{{connected ? deviceName : 'æœªè¿æ¥'}}</text>
      </view>
      
      <!-- æœåŠ¡å™¨è¿æ¥çŠ¶æ€ -->
      <view class="status-item">
        <text class="status-dot {{socketConnected ? 'dot-connected' : 'dot-disconnected'}}"></text>
        <text class="status-label">æœåŠ¡å™¨:</text>
        <text class="status-value">{{socketConnected ? 'å·²è¿æ¥' : (isReconnecting ? 'é‡è¿ä¸­(' + reconnectAttempts + ')' : 'æœªè¿æ¥')}}</text>
      </view>
    </view>
    
    <!-- åŠŸèƒ½æŒ‰é’®åŒº -->
    <view class="toolbar-buttons">
      <view class="toolbar-btn" bindtap="toggleSound">
        <text class="btn-icon">{{soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡'}}</text>
        <text class="btn-label">{{soundEnabled ? 'é™éŸ³' : 'å¼€å£°'}}</text>
      </view>
      <view class="toolbar-btn" bindtap="navigateToCalibration">
        <text class="btn-icon">ğŸ¯</text>
        <text class="btn-label">æ ‡å®š</text>
      </view>
      <view class="toolbar-btn" bindtap="navigateToScan">
        <text class="btn-icon">{{connected ? 'ğŸ”„' : 'ğŸ”'}}</text>
        <text class="btn-label">{{connected ? 'åˆ‡æ¢' : 'è¿æ¥'}}</text>
      </view>
      <view class="toolbar-btn" bindtap="toggleDataSending" wx:if="{{connected}}">
        <text class="btn-icon">{{isDataSending ? 'â¹ï¸' : 'â–¶ï¸'}}</text>
        <text class="btn-label">{{isDataSending ? 'åœæ­¢' : 'å¼€å§‹'}}</text>
      </view>
      <view class="toolbar-btn" bindtap="navigateToHistory">
        <text class="btn-icon">ğŸ“Š</text>
        <text class="btn-label">è®°å½•</text>
      </view>
    </view>
  </view>

  <!-- ä¾§è¾¹æ•°æ®é¢æ¿ - å¯æŠ˜å  -->
  <view class="side-panel {{showDataPanel ? 'panel-open' : 'panel-collapsed'}}" wx:if="{{experimentStarted && currentPhase !== 'æ²»ç–—é˜¶æ®µ'}}">
    <view class="panel-toggle" bindtap="toggleDataPanel">
      <text class="toggle-icon">{{showDataPanel ? 'â—€' : 'â–¶'}}</text>
    </view>
    <view class="panel-content" wx:if="{{showDataPanel}}">
      <view class="data-row">
        <text class="data-label">æ³¨æ„åŠ›åˆ†æ•°</text>
        <text class="data-value">{{powerRatio !== null ? powerRatio : '--'}}</text>
      </view>
      <view class="data-row">
        <text class="data-label">åŸºå‡†å€¼</text>
        <text class="data-value">{{baselineValue !== null ? baselineValue : '--'}}</text>
      </view>
      <view class="data-row">
        <text class="data-label">å½“å‰æ³¨æ„åŠ›</text>
        <text class="data-value">{{currentAttention !== null ? currentAttention : '--'}}</text>
      </view>
      <!-- è¿·ä½ å›¾è¡¨ -->
      <view class="mini-chart">
        <canvas
          canvas-id="eegChart"
          style="width:100%; height:120px;"
          disable-scroll="true"
        ></canvas>
      </view>
    </view>
  </view>

  <!-- åŸºçº¿æ”¶é›†é˜¶æ®µ -->
  <view class="baseline-container" wx:if="{{currentPhase === 'åŸºå‡†é˜¶æ®µ'}}">
    <image class="baseline-bg-image" src="/images/æ­£åœ¨ç”Ÿæˆå°é•‡.png" mode="widthFix"></image>
    <view class="baseline-content">
      <view class="baseline-title">è¯·ä¿æŒæ”¾æ¾ï¼Œå°é•‡æ­£åœ¨ç”Ÿæˆ</view>
      <view class="progress-container">
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{(30-remainingTime)/30*100}}%"></view>
        </view>
        <view class="progress-text">{{Math.floor((30-remainingTime)/30*100)}}%</view>
      </view>
      <view class="baseline-time">å‰©ä½™æ—¶é—´ï¼š{{remainingTime}}ç§’</view>
    </view>
  </view>

  <!-- ä¿å«å°é•‡æ¸¸æˆç•Œé¢ -->
  <view class="game-container" 
        style="top: {{statusBarHeight + toolbarHeight}}rpx; height: {{gameContainerHeight}}rpx;"
        wx:if="{{currentPhase === 'æ²»ç–—é˜¶æ®µ'}}"
        catchtouchmove="preventPageScroll"
        bindtouchstart="onMapTouchStart"
        bindtouchmove="onMapTouchMove"
        bindtouchend="onMapTouchEnd">
    
    <!-- æ³¨æ„åŠ›è¿›åº¦æ¡ - æ¸¸æˆé¡¶éƒ¨ -->
    <view class="attention-progress-bar" wx:if="{{baselineValue !== null}}">
      <view class="attention-progress-bg">
        <!-- è¿›åº¦æ¡å¡«å…… -->
        <view class="attention-progress-fill" style="width: {{attentionProgress}}%"></view>
        <!-- åŸºå‡†å€¼æ ‡è®°çº¿ -->
        <view class="baseline-marker" style="left: {{baselineProgress}}%"></view>
      </view>
      <view class="progress-labels">
        <text class="label-left">æ³¨æ„åŠ›ä½</text>
        <text class="label-center">åŸºå‡†ï¼š{{baselineValue}}</text>
        <text class="label-right">æ³¨æ„åŠ›é«˜</text>
      </view>
    </view>
    
    <!-- æ¸¸æˆèƒŒæ™¯å›¾ç‰‡ -->
    <image wx:if="{{gameBackground}}" class="game-background" src="{{gameBackground}}" mode="aspectFill"></image>
    
    <!-- æ¸¸æˆä¸–ç•Œå®¹å™¨ï¼ˆå¯æ‹–åŠ¨ï¼‰ -->
    <view class="game-world" style="transform: translate({{mapOffsetX}}px, {{mapOffsetY}}px);">
      <!-- å°é•‡ï¼ˆä¸­å¿ƒä½ç½®ï¼‰ -->
      <view class="town" style="left: {{town.x}}rpx; top: {{town.y}}rpx;">
        <view class="town-body">ğŸ°</view>
        <!-- å°é•‡è¡€æ¡ -->
        <view class="health-bar town-health">
          <view class="health-fill" style="width: {{town.hp/town.maxHp*100}}%"></view>
          <text class="health-text">{{town.hp}}/{{town.maxHp}}</text>
        </view>
      </view>

      <!-- ç‚®å° -->
      <view wx:for="{{turrets}}" wx:key="id" class="turret {{item.disabled ? 'turret-disabled' : ''}} {{item.ultimateActive ? 'turret-ultimate' : ''}}" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx; transform: translate(-50%, -50%) rotate({{item.rotation}}deg);">
        <image wx:if="{{item.image}}" class="turret-image {{item.ultimateActive ? 'ultimate-glow' : ''}}" src="{{item.image}}" mode="aspectFit"></image>
        <view wx:else class="turret-body {{item.ultimateActive ? 'ultimate-glow' : ''}}">ğŸ”«</view>
        <!-- å¤§æ‹›å…‰ç¯æ•ˆæœ -->
        <view wx:if="{{item.ultimateActive}}" class="ultimate-aura"></view>
      </view>

      <!-- æ€ªç‰© -->
      <view wx:for="{{monsters}}" wx:key="id" class="monster {{item.isBoss ? 'boss-monster' : ''}}" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <image wx:if="{{item.image}}" class="monster-image {{item.isBoss ? 'boss-image' : ''}}" src="{{item.image}}" mode="aspectFit"></image>
        <view wx:else class="monster-body {{item.isBoss ? 'boss-body' : ''}}">{{item.isBoss ? 'ğŸ‘¹' : 'ğŸ‘¾'}}</view>
        <!-- æ€ªç‰©è¡€æ¡ -->
        <view class="health-bar monster-health" wx:if="{{item.maxHp > 1}}">
          <view class="health-fill monster-fill" style="width: {{item.hp/item.maxHp*100}}%"></view>
        </view>
        <!-- Bossæ ‡è®° -->
        <view wx:if="{{item.isBoss}}" class="boss-label">BOSS</view>
      </view>

      <!-- å­å¼¹ -->
      <view wx:for="{{bullets}}" wx:key="id" class="bullet" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <image wx:if="{{item.image}}" class="bullet-image" src="{{item.image}}" mode="aspectFit"></image>
        <view wx:else class="bullet-body">ğŸ’¥</view>
      </view>

      <!-- çˆ†ç‚¸æ•ˆæœ -->
      <view wx:for="{{explosions}}" wx:key="id" class="explosion" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <view class="explosion-body">ğŸ’¢</view>
      </view>
    </view>

    <!-- æ¸¸æˆçŠ¶æ€é¢æ¿ - å³ä¾§æ»‘å—å½¢å¼ -->
    <view class="game-stats-panel {{showGameStats ? '' : 'stats-panel-collapsed'}}">
      <!-- æŠ˜å æŒ‰é’® -->
      <view class="stats-panel-toggle" bindtap="toggleGameStats">
        <text class="toggle-icon">{{showGameStats ? 'â–¶' : 'â—€'}}</text>
      </view>
      
      <view class="stats-panel-content" wx:if="{{showGameStats}}">
        <view class="stats-title">æ¸¸æˆçŠ¶æ€</view>
        
        <view class="stats-grid">
          <view class="grid-item">
            <text class="grid-label">å­˜æ´»</text>
            <text class="grid-value">{{survivedTime}}s</text>
          </view>
          <view class="grid-item">
            <text class="grid-label">ç­‰çº§</text>
            <text class="grid-value">Lv.{{playerLevel}}</text>
          </view>
          <view class="grid-item">
            <text class="grid-label">æ³¢æ¬¡</text>
            <text class="grid-value">{{currentWave}}</text>
          </view>
          <view class="grid-item">
            <text class="grid-label">å‡»è´¥</text>
            <text class="grid-value">{{defeatedMonsters}}</text>
          </view>
        </view>
        
        <view class="stats-divider"></view>
        
        <view class="attention-section">
          <view class="attention-item">
            <text class="attention-label">åŸºå‡†å€¼</text>
            <text class="attention-value baseline">{{baselineValue || '--'}}</text>
          </view>
          <view class="attention-item">
            <text class="attention-label">å½“å‰å€¼</text>
            <text class="attention-value current">{{currentAttention || '--'}}</text>
          </view>
        </view>
        
        <view class="stats-divider"></view>
        
        <view class="exp-section">
          <view class="exp-header">
            <text class="exp-label">ç»éªŒå€¼</text>
            <text class="exp-text">{{utils.formatExp(experience)}}/{{nextLevelExp}}</text>
          </view>
          <view class="exp-bar">
            <view class="exp-fill" style="width: {{experience/nextLevelExp*100}}%"></view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç‚®å°ä¿¡æ¯é¢æ¿ - å·¦ä¸‹è§’å¯æŠ˜å  -->
    <view class="turret-panel {{showTurretPanel ? '' : 'turret-panel-collapsed'}}">
      <!-- æŠ˜å æŒ‰é’® -->
      <view class="turret-toggle" bindtap="toggleTurretPanel">
        <text class="toggle-icon">{{showTurretPanel ? 'â—€' : 'â–¶'}}</text>
      </view>
      
      <view class="turret-content" wx:if="{{showTurretPanel}}">
        <view class="turret-title">ç‚®å°çŠ¶æ€</view>
        <view class="turret-list">
          <view class="turret-info-item" wx:for="{{turrets}}" wx:key="id">
            <view class="turret-header">
              <text class="turret-icon">âš”ï¸</text>
              <text class="turret-name">ç‚®å° {{index + 1}}</text>
            </view>
            <view class="turret-details">
              <view class="detail-item">
                <text class="detail-label">æ”»å‡»åŠ›</text>
                <text class="detail-value">{{item.damage}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">ç›®æ ‡æ•°</text>
                <text class="detail-value">{{item.targets}}</text>
              </view>
              <view class="detail-item">
                <text class="detail-label">æ”»é€Ÿ</text>
                <text class="detail-value attack-speed">{{item.attackInterval}}ms</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç»“æŸæ¸¸æˆæŒ‰é’® -->
    <view class="end-game-btn" bindtap="endGameManually">
      <text>ç»“æŸæ¸¸æˆ</text>
    </view>

    <!-- æ¸¸æˆå¼€å§‹æç¤º -->
    <view class="game-prompt" wx:if="{{showGamePrompt}}">
      <text class="prompt-text">è¯·é›†ä¸­æ³¨æ„åŠ›ï¼Œä¿å«å°é•‡ï¼</text>
    </view>
    
    <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
    <view class="game-over" wx:if="{{gameOver}}">
      <view class="game-over-content">
        <view class="game-over-title">å°é•‡æ²¦é™·</view>
        <view class="game-over-stats">
          <view>å­˜æ´»æ—¶é—´: {{survivedTime}}ç§’</view>
          <view>æœ€ç»ˆç­‰çº§: {{playerLevel}}</view>
          <view>å‡»è´¥æ€ªç‰©: {{defeatedMonsters}}</view>
          <view>åˆ°è¾¾æ³¢æ¬¡: {{currentWave}}</view>
        </view>
        <view class="game-over-tip">æ¸¸æˆå·²ç»“æŸï¼Œè¯·åœæ­¢å®éªŒåæŸ¥çœ‹å†å²è®°å½•</view>
        <button class="game-over-btn" bindtap="stopExperiment">åœæ­¢å®éªŒ</button>
      </view>
    </view>
  </view>
  
  <!-- åº•éƒ¨æµ®åŠ¨æ“ä½œæ  -->
  <view class="bottom-action-bar" wx:if="{{!experimentStarted || currentPhase !== 'æ²»ç–—é˜¶æ®µ'}}">
    <!-- ä¸»æ“ä½œæŒ‰é’® -->
    <view class="main-action">
      <button
        class="action-btn-large {{socketConnected && connected ? 'btn-ready' : 'btn-disabled'}}"
        bindtap="startExperiment"
        wx:if="{{!experimentStarted && connected}}"
        disabled="{{!socketConnected}}"
      >
        <text class="btn-icon">ğŸš€</text>
        <text class="btn-text">{{socketConnected ? 'å¼€å§‹è®­ç»ƒ' : 'ç­‰å¾…è¿æ¥...'}}</text>
        <text class="btn-hint" wx:if="{{!socketConnected}}">è¯·å…ˆè¿æ¥è®¾å¤‡å’ŒæœåŠ¡å™¨</text>
      </button>

      <button
        class="action-btn-large btn-danger"
        bindtap="stopExperiment"
        wx:if="{{experimentStarted}}"
      >
        <text class="btn-icon">â¹ï¸</text>
        <text class="btn-text">ç»“æŸå®éªŒ</text>
      </button>
    </view>
    
    <!-- æ¬¡è¦æ“ä½œ - é‡æ–°è®¾è®¡å¸ƒå±€ -->
    <view class="secondary-actions" wx:if="{{!experimentStarted}}">
      <view class="action-card" bindtap="showModeSelection">
        <view class="card-header">
          <text class="card-icon">âš™ï¸</text>
          <text class="card-title">æ¸¸æˆæ¨¡å¼è®¾ç½®</text>
        </view>
        <text class="card-desc">{{mode ? (mode === 'auto' ? 'å½“å‰: è‡ªåŠ¨æ¨¡å¼' : 'å½“å‰: æ‰‹åŠ¨æ¨¡å¼') : 'ç‚¹å‡»é€‰æ‹©è®­ç»ƒæ¨¡å¼'}}</text>
        <text class="card-status" wx:if="{{mode}}">{{userType === 'type_A' ? 'Aç±»åˆ¤æ–­é€»è¾‘' : 'Bç±»åˆ¤æ–­é€»è¾‘'}}</text>
      </view>
      
      <view class="action-card" bindtap="navigateToSchulte">
        <view class="card-header">
          <text class="card-icon">ğŸ¯</text>
          <text class="card-title">èˆ’å°”ç‰¹æ–¹æ ¼è®­ç»ƒ</text>
        </view>
        <text class="card-desc">ä¸“æ³¨åŠ›åŸºç¡€è®­ç»ƒå·¥å…·</text>
      </view>
    </view>
  </view>
</view>
