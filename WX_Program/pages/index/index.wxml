<view class="container">
  <!-- å¯åŠ¨å°é¢ -->
  <view class="start-cover" wx:if="{{showStartCover}}">
    <image class="cover-image" src="/images/æ¸¸æˆå°é¢.png" mode="aspectFit"></image>
  </view>

  <!-- é¡¶éƒ¨å·¥å…·æ  - å›ºå®šåœ¨é¡¶éƒ¨ -->
  <view class="top-toolbar">
    <!-- å·¦ä¾§ï¼šè¿æ¥çŠ¶æ€ -->
    <view class="status-compact">
      <text class="status-dot {{connected ? 'dot-connected' : 'dot-disconnected'}}"></text>
      <text class="status-text">{{connected ? deviceName : 'æœªè¿æ¥'}}</text>
    </view>
    
    <!-- å³ä¾§ï¼šå¿«æ·æŒ‰é’® -->
    <view class="toolbar-actions">
      <view class="icon-btn" bindtap="navigateToScan">
        <text class="icon">{{connected ? 'ğŸ”„' : 'ğŸ”'}}</text>
      </view>
      <view class="icon-btn" bindtap="toggleDataSending" wx:if="{{connected}}">
        <text class="icon">{{isDataSending ? 'â¹ï¸' : 'â–¶ï¸'}}</text>
      </view>
      <view class="icon-btn" bindtap="navigateToHistory">
        <text class="icon">ğŸ“Š</text>
      </view>
    </view>
  </view>

  <!-- æœåŠ¡å™¨çŠ¶æ€æŒ‡ç¤ºå™¨ - æµ®åŠ¨æ˜¾ç¤º -->
  <view class="server-indicator {{socketConnected ? 'server-online' : 'server-offline'}}">
    <text class="indicator-dot"></text>
    <text class="indicator-text">{{socketConnected ? 'æœåŠ¡å™¨åœ¨çº¿' : (isReconnecting ? 'é‡è¿ä¸­(' + reconnectAttempts + ')' : 'æœåŠ¡å™¨ç¦»çº¿')}}</text>
  </view>

  <!-- ä¾§è¾¹æ•°æ®é¢æ¿ - å¯æŠ˜å  -->
  <view class="side-panel {{showDataPanel ? 'panel-open' : 'panel-collapsed'}}" wx:if="{{experimentStarted && currentPhase !== 'æ²»ç–—é˜¶æ®µ'}}">
    <view class="panel-toggle" bindtap="toggleDataPanel">
      <text class="toggle-icon">{{showDataPanel ? 'â—€' : 'â–¶'}}</text>
    </view>
    <view class="panel-content" wx:if="{{showDataPanel}}">
      <view class="data-row">
        <text class="data-label">æ ·æœ¬ç†µ</text>
        <text class="data-value">{{powerRatio !== null ? powerRatio : '--'}}</text>
      </view>
      <view class="data-row">
        <text class="data-label">åŸºå‡†å€¼</text>
        <text class="data-value">{{baselineValue !== null ? baselineValue : '--'}}</text>
      </view>
      <view class="data-row">
        <text class="data-label">å½“å‰æ³¨æ„åŠ›</text>
        <text class="data-value">{{currentAttention !== null ? currentAttention : '--'}}</text>
      </view>
      <!-- è¿·ä½ å›¾è¡¨ -->
      <view class="mini-chart">
        <canvas
          canvas-id="eegChart"
          style="width:100%; height:120px;"
          disable-scroll="true"
        ></canvas>
      </view>
    </view>
  </view>

  <!-- åŸºçº¿æ”¶é›†é˜¶æ®µ -->
  <view class="baseline-container" wx:if="{{currentPhase === 'åŸºå‡†é˜¶æ®µ'}}">
    <view class="baseline-title">è¯·ä¿æŒæ”¾æ¾ï¼Œå°é•‡æ­£åœ¨ç”Ÿæˆ</view>
    <view class="progress-container">
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{(30-remainingTime)/30*100}}%"></view>
      </view>
      <view class="progress-text">{{Math.floor((30-remainingTime)/30*100)}}%</view>
    </view>
    <view class="baseline-time">å‰©ä½™æ—¶é—´ï¼š{{remainingTime}}ç§’</view>
  </view>

  <!-- ä¿å«å°é•‡æ¸¸æˆç•Œé¢ -->
  <view class="game-container" wx:if="{{currentPhase === 'æ²»ç–—é˜¶æ®µ'}}"
        catchtouchmove="preventPageScroll"
        bindtouchstart="onMapTouchStart"
        bindtouchmove="onMapTouchMove"
        bindtouchend="onMapTouchEnd">
    
    <!-- æ¸¸æˆä¸–ç•Œå®¹å™¨ï¼ˆå¯æ‹–åŠ¨ï¼‰ -->
    <view class="game-world" style="transform: translate({{mapOffsetX}}px, {{mapOffsetY}}px);">
      <!-- å°é•‡ï¼ˆä¸­å¿ƒä½ç½®ï¼‰ -->
      <view class="town" style="left: {{town.x}}rpx; top: {{town.y}}rpx;">
        <view class="town-body">ğŸ°</view>
        <!-- å°é•‡è¡€æ¡ -->
        <view class="health-bar town-health">
          <view class="health-fill" style="width: {{town.hp/town.maxHp*100}}%"></view>
          <text class="health-text">{{town.hp}}/{{town.maxHp}}</text>
        </view>
      </view>

      <!-- ç‚®å° -->
      <view wx:for="{{turrets}}" wx:key="id" class="turret" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx; transform: translate(-50%, -50%) rotate({{item.rotation}}deg);">
        <view class="turret-body">ğŸ”«</view>
      </view>

      <!-- æ€ªç‰© -->
      <view wx:for="{{monsters}}" wx:key="id" class="monster {{item.isBoss ? 'boss-monster' : ''}}" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <view class="monster-body {{item.isBoss ? 'boss-body' : ''}}">{{item.isBoss ? 'ğŸ‘¹' : 'ğŸ‘¾'}}</view>
        <!-- æ€ªç‰©è¡€æ¡ -->
        <view class="health-bar monster-health" wx:if="{{item.maxHp > 1}}">
          <view class="health-fill monster-fill" style="width: {{item.hp/item.maxHp*100}}%"></view>
        </view>
        <!-- Bossæ ‡è®° -->
        <view wx:if="{{item.isBoss}}" class="boss-label">BOSS</view>
      </view>

      <!-- å­å¼¹ -->
      <view wx:for="{{bullets}}" wx:key="id" class="bullet" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <view class="bullet-body">ğŸ’¥</view>
      </view>

      <!-- çˆ†ç‚¸æ•ˆæœ -->
      <view wx:for="{{explosions}}" wx:key="id" class="explosion" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <view class="explosion-body">ğŸ’¢</view>
      </view>
    </view>

    <!-- æ¸¸æˆçŠ¶æ€é¢æ¿ -->
    <view class="game-stats">
      <view class="stat-row">
        <view class="stat-item">
          <text class="stat-label">å­˜æ´»</text>
          <text class="stat-value">{{survivedTime}}s</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">ç­‰çº§</text>
          <text class="stat-value">{{playerLevel}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">æ³¢æ¬¡</text>
          <text class="stat-value">{{currentWave}}</text>
        </view>
      </view>
      <view class="stat-row">
        <view class="stat-item">
          <text class="stat-label">åŸºå‡†</text>
          <text class="stat-value">{{baselineValue || '--'}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å½“å‰</text>
          <text class="stat-value">{{currentAttention || '--'}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å‡»è´¥</text>
          <text class="stat-value">{{defeatedMonsters}}</text>
        </view>
      </view>
      <view class="stat-row">
        <view class="stat-item-full">
          <text class="stat-label">ç»éªŒ</text>
          <text class="stat-value">{{experience}}/{{nextLevelExp}}</text>
        </view>
      </view>
      <view class="exp-bar">
        <view class="exp-fill" style="width: {{experience/nextLevelExp*100}}%"></view>
      </view>
    </view>

    <!-- ç»“æŸæ¸¸æˆæŒ‰é’® -->
    <view class="end-game-btn" bindtap="endGameManually">
      <text>ç»“æŸæ¸¸æˆ</text>
    </view>

    <!-- æ¸¸æˆå¼€å§‹æç¤º -->
    <view class="game-prompt" wx:if="{{showGamePrompt}}">
      <text class="prompt-text">è¯·é›†ä¸­æ³¨æ„åŠ›ï¼Œä¿å«å°é•‡ï¼</text>
    </view>
    
    <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
    <view class="game-over" wx:if="{{gameOver}}">
      <view class="game-over-content">
        <view class="game-over-title">å°é•‡æ²¦é™·</view>
        <view class="game-over-stats">
          <view>å­˜æ´»æ—¶é—´: {{survivedTime}}ç§’</view>
          <view>æœ€ç»ˆç­‰çº§: {{playerLevel}}</view>
          <view>å‡»è´¥æ€ªç‰©: {{defeatedMonsters}}</view>
          <view>åˆ°è¾¾æ³¢æ¬¡: {{currentWave}}</view>
        </view>
        <button class="restart-btn" bindtap="restartExperiment">é‡æ–°å¼€å§‹</button>
      </view>
    </view>
  </view>
  
  <!-- åº•éƒ¨æµ®åŠ¨æ“ä½œæ  -->
  <view class="bottom-action-bar" wx:if="{{!experimentStarted || currentPhase !== 'æ²»ç–—é˜¶æ®µ'}}">
    <!-- ä¸»æ“ä½œæŒ‰é’® -->
    <view class="main-action">
      <button
        class="action-btn-large {{socketConnected && connected ? 'btn-ready' : 'btn-disabled'}}"
        bindtap="startExperiment"
        wx:if="{{!experimentStarted && connected}}"
        disabled="{{!socketConnected}}"
      >
        <text class="btn-icon">ğŸš€</text>
        <text class="btn-text">{{socketConnected ? 'å¼€å§‹è®­ç»ƒ' : 'ç­‰å¾…è¿æ¥...'}}</text>
      </button>

      <button
        class="action-btn-large btn-danger"
        bindtap="stopExperiment"
        wx:if="{{experimentStarted}}"
      >
        <text class="btn-icon">â¹ï¸</text>
        <text class="btn-text">ç»“æŸå®éªŒ</text>
      </button>
    </view>
    
    <!-- æ¬¡è¦æ“ä½œ -->
    <view class="secondary-actions" wx:if="{{!experimentStarted}}">
      <view class="action-item" bindtap="navigateToSchulte">
        <text class="action-icon">ğŸ¯</text>
        <text class="action-label">èˆ’å°”ç‰¹</text>
      </view>
    </view>
  </view>
</view>
