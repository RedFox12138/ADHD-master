<view class="container">
  <!-- 启动封面 -->
  <view class="start-cover" wx:if="{{showStartCover}}">
    <image class="cover-image" src="/images/游戏封面.png" mode="aspectFit"></image>
  </view>

  <!-- 顶部工具栏 - 固定在顶部 -->
  <view class="top-toolbar">
    <!-- 左侧：连接状态 -->
    <view class="status-compact">
      <text class="status-dot {{connected ? 'dot-connected' : 'dot-disconnected'}}"></text>
      <text class="status-text">{{connected ? deviceName : '未连接'}}</text>
    </view>
    
    <!-- 右侧：快捷按钮 -->
    <view class="toolbar-actions">
      <view class="icon-btn" bindtap="navigateToScan">
        <text class="icon">{{connected ? '🔄' : '🔍'}}</text>
      </view>
      <view class="icon-btn" bindtap="toggleDataSending" wx:if="{{connected}}">
        <text class="icon">{{isDataSending ? '⏹️' : '▶️'}}</text>
      </view>
      <view class="icon-btn" bindtap="navigateToHistory">
        <text class="icon">📊</text>
      </view>
    </view>
  </view>

  <!-- 服务器状态指示器 - 浮动显示 -->
  <view class="server-indicator {{socketConnected ? 'server-online' : 'server-offline'}}">
    <text class="indicator-dot"></text>
    <text class="indicator-text">{{socketConnected ? '服务器在线' : (isReconnecting ? '重连中(' + reconnectAttempts + ')' : '服务器离线')}}</text>
  </view>

  <!-- 侧边数据面板 - 可折叠 -->
  <view class="side-panel {{showDataPanel ? 'panel-open' : 'panel-collapsed'}}" wx:if="{{experimentStarted && currentPhase !== '治疗阶段'}}">
    <view class="panel-toggle" bindtap="toggleDataPanel">
      <text class="toggle-icon">{{showDataPanel ? '◀' : '▶'}}</text>
    </view>
    <view class="panel-content" wx:if="{{showDataPanel}}">
      <view class="data-row">
        <text class="data-label">样本熵</text>
        <text class="data-value">{{powerRatio !== null ? powerRatio : '--'}}</text>
      </view>
      <view class="data-row">
        <text class="data-label">基准值</text>
        <text class="data-value">{{baselineValue !== null ? baselineValue : '--'}}</text>
      </view>
      <view class="data-row">
        <text class="data-label">当前注意力</text>
        <text class="data-value">{{currentAttention !== null ? currentAttention : '--'}}</text>
      </view>
      <!-- 迷你图表 -->
      <view class="mini-chart">
        <canvas
          canvas-id="eegChart"
          style="width:100%; height:120px;"
          disable-scroll="true"
        ></canvas>
      </view>
    </view>
  </view>

  <!-- 基线收集阶段 -->
  <view class="baseline-container" wx:if="{{currentPhase === '基准阶段'}}">
    <view class="baseline-title">请保持放松，小镇正在生成</view>
    <view class="progress-container">
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{(30-remainingTime)/30*100}}%"></view>
      </view>
      <view class="progress-text">{{Math.floor((30-remainingTime)/30*100)}}%</view>
    </view>
    <view class="baseline-time">剩余时间：{{remainingTime}}秒</view>
  </view>

  <!-- 保卫小镇游戏界面 -->
  <view class="game-container" wx:if="{{currentPhase === '治疗阶段'}}"
        catchtouchmove="preventPageScroll"
        bindtouchstart="onMapTouchStart"
        bindtouchmove="onMapTouchMove"
        bindtouchend="onMapTouchEnd">
    
    <!-- 游戏世界容器（可拖动） -->
    <view class="game-world" style="transform: translate({{mapOffsetX}}px, {{mapOffsetY}}px);">
      <!-- 小镇（中心位置） -->
      <view class="town" style="left: {{town.x}}rpx; top: {{town.y}}rpx;">
        <view class="town-body">🏰</view>
        <!-- 小镇血条 -->
        <view class="health-bar town-health">
          <view class="health-fill" style="width: {{town.hp/town.maxHp*100}}%"></view>
          <text class="health-text">{{town.hp}}/{{town.maxHp}}</text>
        </view>
      </view>

      <!-- 炮台 -->
      <view wx:for="{{turrets}}" wx:key="id" class="turret" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx; transform: translate(-50%, -50%) rotate({{item.rotation}}deg);">
        <view class="turret-body">🔫</view>
      </view>

      <!-- 怪物 -->
      <view wx:for="{{monsters}}" wx:key="id" class="monster {{item.isBoss ? 'boss-monster' : ''}}" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <view class="monster-body {{item.isBoss ? 'boss-body' : ''}}">{{item.isBoss ? '👹' : '👾'}}</view>
        <!-- 怪物血条 -->
        <view class="health-bar monster-health" wx:if="{{item.maxHp > 1}}">
          <view class="health-fill monster-fill" style="width: {{item.hp/item.maxHp*100}}%"></view>
        </view>
        <!-- Boss标记 -->
        <view wx:if="{{item.isBoss}}" class="boss-label">BOSS</view>
      </view>

      <!-- 子弹 -->
      <view wx:for="{{bullets}}" wx:key="id" class="bullet" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <view class="bullet-body">💥</view>
      </view>

      <!-- 爆炸效果 -->
      <view wx:for="{{explosions}}" wx:key="id" class="explosion" 
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;">
        <view class="explosion-body">💢</view>
      </view>
    </view>

    <!-- 游戏状态面板 -->
    <view class="game-stats">
      <view class="stat-row">
        <view class="stat-item">
          <text class="stat-label">存活</text>
          <text class="stat-value">{{survivedTime}}s</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">等级</text>
          <text class="stat-value">{{playerLevel}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">波次</text>
          <text class="stat-value">{{currentWave}}</text>
        </view>
      </view>
      <view class="stat-row">
        <view class="stat-item">
          <text class="stat-label">基准</text>
          <text class="stat-value">{{baselineValue || '--'}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">当前</text>
          <text class="stat-value">{{currentAttention || '--'}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">击败</text>
          <text class="stat-value">{{defeatedMonsters}}</text>
        </view>
      </view>
      <view class="stat-row">
        <view class="stat-item-full">
          <text class="stat-label">经验</text>
          <text class="stat-value">{{experience}}/{{nextLevelExp}}</text>
        </view>
      </view>
      <view class="exp-bar">
        <view class="exp-fill" style="width: {{experience/nextLevelExp*100}}%"></view>
      </view>
    </view>

    <!-- 结束游戏按钮 -->
    <view class="end-game-btn" bindtap="endGameManually">
      <text>结束游戏</text>
    </view>

    <!-- 游戏开始提示 -->
    <view class="game-prompt" wx:if="{{showGamePrompt}}">
      <text class="prompt-text">请集中注意力，保卫小镇！</text>
    </view>
    
    <!-- 游戏结束界面 -->
    <view class="game-over" wx:if="{{gameOver}}">
      <view class="game-over-content">
        <view class="game-over-title">小镇沦陷</view>
        <view class="game-over-stats">
          <view>存活时间: {{survivedTime}}秒</view>
          <view>最终等级: {{playerLevel}}</view>
          <view>击败怪物: {{defeatedMonsters}}</view>
          <view>到达波次: {{currentWave}}</view>
        </view>
        <button class="restart-btn" bindtap="restartExperiment">重新开始</button>
      </view>
    </view>
  </view>
  
  <!-- 底部浮动操作栏 -->
  <view class="bottom-action-bar" wx:if="{{!experimentStarted || currentPhase !== '治疗阶段'}}">
    <!-- 主操作按钮 -->
    <view class="main-action">
      <button
        class="action-btn-large {{socketConnected && connected ? 'btn-ready' : 'btn-disabled'}}"
        bindtap="startExperiment"
        wx:if="{{!experimentStarted && connected}}"
        disabled="{{!socketConnected}}"
      >
        <text class="btn-icon">🚀</text>
        <text class="btn-text">{{socketConnected ? '开始训练' : '等待连接...'}}</text>
      </button>

      <button
        class="action-btn-large btn-danger"
        bindtap="stopExperiment"
        wx:if="{{experimentStarted}}"
      >
        <text class="btn-icon">⏹️</text>
        <text class="btn-text">结束实验</text>
      </button>
    </view>
    
    <!-- 次要操作 -->
    <view class="secondary-actions" wx:if="{{!experimentStarted}}">
      <view class="action-item" bindtap="navigateToSchulte">
        <text class="action-icon">🎯</text>
        <text class="action-label">舒尔特</text>
      </view>
    </view>
  </view>
</view>
