<!-- pages/history/history.wxml -->
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <view class="title">ğŸ“Š å†å²æ•°æ®åˆ†æ</view>
    <view class="subtitle">æŸ¥çœ‹æ‚¨çš„ADHDæ£€æµ‹å†å²è®°å½•</view>
  </view>

  <!-- æ•°æ®ç±»å‹åˆ‡æ¢ -->
  <view class="type-switch" wx:if="{{!showChart}}">
    <button 
      class="type-btn {{dataType === 'feature' ? 'active' : ''}}"
      bindtap="switchDataType"
      data-type="feature">
      ğŸ“ˆ ç‰¹å¾æ•°æ®
    </button>
    <button 
      class="type-btn {{dataType === 'gameRecords' ? 'active' : ''}}"
      bindtap="switchDataType"
      data-type="gameRecords">
      ğŸ® è®­ç»ƒè®°å½•
    </button>
  </view>

  <!-- æ¸¸æˆè®°å½•è§†å›¾ -->
  <view class="game-records-section" wx:if="{{dataType === 'gameRecords' && showChart}}">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-grid">
      <view class="stat-card">
        <view class="stat-icon">ğŸ®</view>
        <view class="stat-value">{{totalGames}}</view>
        <view class="stat-label">è®­ç»ƒæ¬¡æ•°</view>
      </view>

      <view class="stat-card">
        <view class="stat-icon">â±ï¸</view>
        <view class="stat-value">{{avgTime}}ç§’</view>
        <view class="stat-label">å¹³å‡æ—¶é•¿</view>
      </view>

      <view class="stat-card">
        <view class="stat-icon">ğŸ†</view>
        <view class="stat-value">{{maxTime}}ç§’</view>
        <view class="stat-label">æœ€ä½³è®°å½•</view>
      </view>

      <view class="stat-card trend-{{trend}}">
        <view class="stat-icon">
          {{trend === 'improving' ? 'ğŸ“ˆ' : trend === 'declining' ? 'ğŸ“‰' : 'â¡ï¸'}}
        </view>
        <view class="stat-value">
          {{trend === 'improving' ? 'è¿›æ­¥ä¸­' : trend === 'declining' ? 'éœ€åŠ æ²¹' : trend === 'insufficient' ? 'æ•°æ®ä¸è¶³' : 'ç¨³å®š'}}
        </view>
        <view class="stat-label">è¶‹åŠ¿åˆ†æ</view>
      </view>
    </view>

    <!-- æ™ºèƒ½å»ºè®®å¡ç‰‡ -->
    <view wx:if="{{suggestion}}" class="suggestion-card">
      <view class="suggestion-header">
        <text class="suggestion-icon">ğŸ’¡</text>
        <text class="suggestion-title">æ™ºèƒ½åˆ†æä¸å»ºè®®</text>
      </view>
      <view class="suggestion-content">{{suggestion}}</view>
    </view>

    <!-- å›¾è¡¨ -->
    <view class="chart-header">
      <view class="chart-title">ğŸ“ˆ è®­ç»ƒæ—¶é•¿è¶‹åŠ¿</view>
      <button class="back-btn" bindtap="switchDataType" data-type="feature">â† è¿”å›</button>
    </view>

    <view class="chart-container">
      <canvas type="2d" id="historyChart" class="chart-canvas"></canvas>
    </view>
  </view>

  <!-- æ—¥æœŸé€‰æ‹© -->
  <view wx:if="{{!showChart && dataType !== 'gameRecords'}}" class="content-section">
    <!-- æ—¥æœŸåˆ—è¡¨ -->
    <view class="section-header">
      <view class="section-title">ğŸ“… é€‰æ‹©æ—¥æœŸ</view>
      <view class="section-desc">ç‚¹å‡»æ—¥æœŸæŸ¥çœ‹{{dataType === 'feature' ? 'ç‰¹å¾æ•°æ®' : 'åŸå§‹ä¿¡å·'}}è®°å½•</view>
    </view>

    <view class="date-grid">
      <view wx:for="{{historyDates}}"
            wx:key="value"
            class="date-card {{selectedDate === item.value ? 'selected' : ''}}"
            bindtap="selectDate"
            data-date="{{item.value}}">
        <view class="date-icon">ğŸ“…</view>
        <view class="date-text">{{item.text}}</view>
        <view class="date-badge" wx:if="{{item.count}}">{{item.count}}æ¡è®°å½•</view>
      </view>
    </view>

    <!-- æ–‡ä»¶åˆ—è¡¨ -->
    <view class="section-header" wx:if="{{selectedDate}}">
      <view class="section-title">ğŸ“ {{dataType === 'feature' ? 'ç‰¹å¾æ–‡ä»¶' : 'åŸå§‹ä¿¡å·æ–‡ä»¶'}}</view>
      <view class="section-desc">é€‰æ‹©è¦æŸ¥çœ‹çš„å…·ä½“æ–‡ä»¶</view>
    </view>

    <view class="file-grid" wx:if="{{selectedDate && historyFiles.length}}">
      <scroll-view scroll-y class="file-scroll">
        <view wx:for="{{historyFiles}}"
              wx:key="name"
              class="file-card"
              bindtap="viewFile"
              data-file="{{item.fullName}}">
          <view class="file-icon">ğŸ“„</view>
          <view class="file-info">
            <view class="file-name">{{item.name}}</view>
            <view class="file-time">{{item.time || 'æ—¶é—´æœªçŸ¥'}}</view>
          </view>
          <view class="file-arrow">â¤</view>
        </view>
      </scroll-view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{selectedDate && !historyFiles.length}}">
      <view class="empty-icon">ğŸ“­</view>
      <view class="empty-title">æš‚æ— è®°å½•</view>
      <view class="empty-desc">è¯¥æ—¥æœŸä¸‹æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶</view>
    </view>
  </view>

  <!-- å›¾è¡¨è§†å›¾ (ç‰¹å¾æ•°æ®å’ŒåŸå§‹ä¿¡å·) -->
  <view class="chart-section" wx:if="{{showChart && dataType !== 'gameRecords'}}">
    <view class="chart-header">
      <view class="chart-title">
        ğŸ“ˆ {{dataType === 'feature' ? 'ç‰¹å¾æ—¶åºå›¾' : 'åŸå§‹ä¿¡å·å›¾'}}
      </view>
      <button class="back-btn" bindtap="backToList">â† è¿”å›</button>
    </view>

    <!-- å›¾è¡¨ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰ -->
    <view class="chart-info-simple" wx:if="{{dataType === 'feature' && chartData.baseline !== null && chartData.baseline !== undefined}}">
      <text class="info-text">åŸºçº¿: {{chartData.baseline.toFixed(2)}}</text>
    </view>

    <!-- å›¾è¡¨å®¹å™¨ -->
    <view class="chart-container">
      <canvas type="2d" id="historyChart" class="chart-canvas"></canvas>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <view class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®...</view>
  </view>
</view>