<!-- pages/history/history.wxml -->
<view class="container">
  <!-- 页面标题 -->
  <view class="page-header">
    <view class="title">📊 历史数据分析</view>
    <view class="subtitle">查看您的ADHD检测历史记录</view>
  </view>

  <!-- 数据类型切换 -->
  <view class="type-switch" wx:if="{{!showChart}}">
    <button 
      class="type-btn {{dataType === 'feature' ? 'active' : ''}}"
      bindtap="switchDataType"
      data-type="feature">
      📈 特征数据
    </button>
    <button 
      class="type-btn {{dataType === 'gameRecords' ? 'active' : ''}}"
      bindtap="switchDataType"
      data-type="gameRecords">
      🎮 训练记录
    </button>
  </view>

  <!-- 游戏记录视图 -->
  <view class="game-records-section" wx:if="{{dataType === 'gameRecords' && showChart}}">
    <!-- 统计卡片 -->
    <view class="stats-grid">
      <view class="stat-card">
        <view class="stat-icon">🎮</view>
        <view class="stat-value">{{totalGames}}</view>
        <view class="stat-label">训练次数</view>
      </view>

      <view class="stat-card">
        <view class="stat-icon">⏱️</view>
        <view class="stat-value">{{avgTime}}秒</view>
        <view class="stat-label">平均时长</view>
      </view>

      <view class="stat-card">
        <view class="stat-icon">🏆</view>
        <view class="stat-value">{{maxTime}}秒</view>
        <view class="stat-label">最佳记录</view>
      </view>

      <view class="stat-card trend-{{trend}}">
        <view class="stat-icon">
          {{trend === 'improving' ? '📈' : trend === 'declining' ? '📉' : '➡️'}}
        </view>
        <view class="stat-value">
          {{trend === 'improving' ? '进步中' : trend === 'declining' ? '需加油' : trend === 'insufficient' ? '数据不足' : '稳定'}}
        </view>
        <view class="stat-label">趋势分析</view>
      </view>
    </view>

    <!-- 智能建议卡片 -->
    <view wx:if="{{suggestion}}" class="suggestion-card">
      <view class="suggestion-header">
        <text class="suggestion-icon">💡</text>
        <text class="suggestion-title">智能分析与建议</text>
      </view>
      <view class="suggestion-content">{{suggestion}}</view>
    </view>

    <!-- 图表 -->
    <view class="chart-header">
      <view class="chart-title">📈 训练时长趋势</view>
      <button class="back-btn" bindtap="switchDataType" data-type="feature">← 返回</button>
    </view>

    <view class="chart-container">
      <canvas type="2d" id="historyChart" class="chart-canvas"></canvas>
    </view>
  </view>

  <!-- 日期选择 -->
  <view wx:if="{{!showChart && dataType !== 'gameRecords'}}" class="content-section">
    <!-- 日期列表 -->
    <view class="section-header">
      <view class="section-title">📅 选择日期</view>
      <view class="section-desc">点击日期查看{{dataType === 'feature' ? '特征数据' : '原始信号'}}记录</view>
    </view>

    <view class="date-grid">
      <view wx:for="{{historyDates}}"
            wx:key="value"
            class="date-card {{selectedDate === item.value ? 'selected' : ''}}"
            bindtap="selectDate"
            data-date="{{item.value}}">
        <view class="date-icon">📅</view>
        <view class="date-text">{{item.text}}</view>
        <view class="date-badge" wx:if="{{item.count}}">{{item.count}}条记录</view>
      </view>
    </view>

    <!-- 文件列表 -->
    <view class="section-header" wx:if="{{selectedDate}}">
      <view class="section-title">📁 {{dataType === 'feature' ? '特征文件' : '原始信号文件'}}</view>
      <view class="section-desc">选择要查看的具体文件</view>
    </view>

    <view class="file-grid" wx:if="{{selectedDate && historyFiles.length}}">
      <scroll-view scroll-y class="file-scroll">
        <view wx:for="{{historyFiles}}"
              wx:key="name"
              class="file-card"
              bindtap="viewFile"
              data-file="{{item.fullName}}">
          <view class="file-icon">📄</view>
          <view class="file-info">
            <view class="file-name">{{item.name}}</view>
            <view class="file-time">{{item.time || '时间未知'}}</view>
          </view>
          <view class="file-arrow">➤</view>
        </view>
      </scroll-view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{selectedDate && !historyFiles.length}}">
      <view class="empty-icon">📭</view>
      <view class="empty-title">暂无记录</view>
      <view class="empty-desc">该日期下没有找到文件</view>
    </view>
  </view>

  <!-- 图表视图 (特征数据和原始信号) -->
  <view class="chart-section" wx:if="{{showChart && dataType !== 'gameRecords'}}">
    <view class="chart-header">
      <view class="chart-title">
        📈 {{dataType === 'feature' ? '特征时序图' : '原始信号图'}}
      </view>
      <button class="back-btn" bindtap="backToList">← 返回</button>
    </view>

    <!-- 图表信息（简化版） -->
    <view class="chart-info-simple" wx:if="{{dataType === 'feature' && chartData.baseline !== null && chartData.baseline !== undefined}}">
      <text class="info-text">基线: {{chartData.baseline.toFixed(2)}}</text>
    </view>

    <!-- 图表容器 -->
    <view class="chart-container">
      <canvas type="2d" id="historyChart" class="chart-canvas"></canvas>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <view class="loading-text">正在加载数据...</view>
  </view>
</view>